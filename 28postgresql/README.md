# Vagrant-стенд c Postgres

# Цель домашнего задания
Научиться настраивать репликацию и создавать резервные копии в СУБД PostgreSQL

# Описание домашнего задания
1) Настроить hot_standby репликацию с использованием слотов
2) Настроить правильное резервное копирование
# Введение
PostgreSQL — свободная объектно-реляционная система управления базами данных (СУБД). 
# Основные термины в Postgres:
Кластер - объединение нескольких баз данных. В postgres это означает что на одном хосте создаётся несколько баз сразу. 
База данных - физическое объединение объектов
Схема - логическое объединение таблиц в базе данных. По умолчанию в postgres создаётся одна схема под названием Public
# По умолчанию в кластере находятся:
- template0 - read only БД, содержащая инициализационный набор данных
- template1 - база-шаблон для создания новых баз
- postgres (при желании можно поменять название). В базе находятся служебные таблицы, можно также использовать данную базу для своих нужд, но это не рекомендуется.

Управлять базами, таблицами и данными можно не только с помощью консольной утилиты psql, но и с помощью GUI-утилит, например pgAdmin, Dbeaver  и т. д.

Postgres - это мультироцессное приложение. Состоит из главного процесса (postgres), который отвечает за подключение клиентов, взаимодействие с кэшом и отвечает за остальные процессы (background processes).

# Основные конфигурационные файлы в Postgres: 
pg_hba.conf -  файл задаёт способ доступа к базам и репликации из различных источников.
postgresql.conf - файл конфигурации, обычно находится в каталоге данных, может редактироваться вручную. Может быть несколько значений одного и того же параметра, тогда вступает в силу последнее значение.
postgresql.auto.conf - предназначен для автоматического изменения параметров postgres

# WAL (Write Ahead Log) - журнал упреждающей записи
В WAL записывается информация, достаточная для повторного выполнения всех действий с БД.
Записи этого журнала обязаны попасть на диск раньше, чем изменения в соответствующей странице. Журнал состоит из нескольких файлов (обычно по 16МБ), которые циклически перезаписываются.

Репликация - процесс синхронизации нескольких копий одного объекта. Решает задачу отказоустойчивости и масштабируемости.

# Задачи репликации:
балансировка нагрузки
резервирование (НЕ БЭКАП, бэкап можно делать с реплики)
обновление без остановки системы
горизонтальное масштабирование
геораспределение нагрузки

# Виды репликации:
Физическая репликация - описание изменений на уровне файлов. Побайтовая копия данных.
Логическая репликация - изменения данных в терминах строк таблиц. Более высокий уровень, чем файлы

Помимо репликации, рекомендуется создавать резервные копии. Они могут потребоваться, если вдруг сервера СУБД выйдут из строя. 


Запускаем наш Vagrantfile
``` 
vagrantfile up --no-provision
```
После установки нод запускаем настройку репликации и бекапировани с помощью ansible

```
vagrantfile up --provision
```


проверяем как синхронизируется со slave наша db


# NODE1
Создаем базу данных 

```
postgres=# CREATE DATABASE otus_test;
CREATE DATABASE
postgres=# postgres=# \l
                                  List of databases
   Name    |  Owner   | Encoding |   Collate   |    Ctype    |   Access privileges   
-----------+----------+----------+-------------+-------------+-----------------------
 otus_test | postgres | UTF8     | en_US.UTF-8 | en_US.UTF-8 | 
 postgres  | postgres | UTF8     | en_US.UTF-8 | en_US.UTF-8 | 
 template0 | postgres | UTF8     | en_US.UTF-8 | en_US.UTF-8 | =c/postgres          +
           |          |          |             |             | postgres=CTc/postgres
 template1 | postgres | UTF8     | en_US.UTF-8 | en_US.UTF-8 | =c/postgres          +
           |          |          |             |             | postgres=CTc/postgres
(4 rows)
```


# NODE2
проверяем репликацию

```
postgres=# postgres=# \l
                                  List of databases
   Name    |  Owner   | Encoding |   Collate   |    Ctype    |   Access privileges   
-----------+----------+----------+-------------+-------------+-----------------------
 otus_test | postgres | UTF8     | en_US.UTF-8 | en_US.UTF-8 | 
 postgres  | postgres | UTF8     | en_US.UTF-8 | en_US.UTF-8 | 
 template0 | postgres | UTF8     | en_US.UTF-8 | en_US.UTF-8 | =c/postgres          +
           |          |          |             |             | postgres=CTc/postgres
 template1 | postgres | UTF8     | en_US.UTF-8 | en_US.UTF-8 | =c/postgres          +
           |          |          |             |             | postgres=CTc/postgres
(4 rows)
```

Так же можно проверить таким методом

# NODE1

```
postgres=# select * from pg_stat_replication;
  pid  | usesysid |   usename   | application_name |  client_addr  | client_hostname | client_port |         backend_start         | backend_xmin |   state   | sent_lsn  | write_lsn | flus
h_lsn | replay_lsn | write_lag | flush_lag | replay_lag | sync_priority | sync_state |          reply_time           
-------+----------+-------------+------------------+---------------+-----------------+-------------+-------------------------------+--------------+-----------+-----------+-----------+-----
------+------------+-----------+-----------+------------+---------------+------------+-------------------------------
 23958 |    16384 | replication | walreceiver      | 192.168.57.12 |                 |       35534 | 2023-08-28 16:54:22.767236-03 |          736 | streaming | 0/3000AB8 | 0/3000AB8 | 0/30
00AB8 | 0/3000AB8  |           |           |            |             0 | async      | 2023-08-28 16:57:13.464156-03
(1 row)
```


# NODE2
```
postgres=# select * from pg_stat_wal_receiver;
  pid  |  status   | receive_start_lsn | receive_start_tli | written_lsn | flushed_lsn | received_tli |      last_msg_send_time       |     last_msg_receipt_time     | latest_end_lsn |    
    latest_end_time        | slot_name |  sender_host  | sender_port |                                                                                                                      
                   conninfo                                                                                                                                         
-------+-----------+-------------------+-------------------+-------------+-------------+--------------+-------------------------------+-------------------------------+----------------+----
---------------------------+-----------+---------------+-------------+----------------------------------------------------------------------------------------------------------------------
--------------------------------------------------------------------------------------------------------------------------------------------------------------------
 23558 | streaming | 0/3000000         |                 1 | 0/3000AB8   | 0/3000AB8   |            1 | 2023-08-28 16:57:32.042361-03 | 2023-08-28 16:57:32.186893-03 | 0/3000AB8      | 202
3-08-28 16:56:32.010318-03 |           | 192.168.57.11 |        5432 | user=replication password=******** channel_binding=prefer dbname=replication host=192.168.57.11 port=5432 fallback_ap
plication_name=walreceiver sslmode=prefer sslcompression=0 sslsni=1 ssl_min_protocol_version=TLSv1.2 gssencmode=prefer krbsrvname=postgres target_session_attrs=any
(1 row)
```

